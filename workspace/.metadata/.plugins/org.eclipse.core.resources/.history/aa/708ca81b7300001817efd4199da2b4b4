#include <ESP8266WiFi.h>
#include <WiFiClient.h>
#include <ESP8266WebServer.h>
#include <ESP8266mDNS.h>

#include <Wire.h>
#include "OLED.h"

#include "LiquidCrystal_I2C.h"

#include <OneWire.h>
#include "DallasTemperature.h"
#include "BeeperB.h"
#include "ButtonB.h"
#include "LedB.h"
#include "TimeTrigger.h"
#include <RtcDS3231.h>
#include "SensorsDS18_helper.h"
#include "DHT.h"

const char *ssid = "balabasKiev5";
const char *password = "wuWylKegayg2wu22";

const char* www_username = "balabas";
const char* www_password = "balabas";

char *DeviceId;

const uint8_t okButtonPin=13;
const uint8_t pageButtonPin=2;

const uint8_t am2301Pin=14;
#define DHTTYPE DHT21   // DHT 21 (AM2301)
DHT dht(am2301Pin, DHTTYPE);
float humidity;
float temperature;

LedB greenLed(9);
LedB redLed(10);
//BeeperB beeper(5);

TimeTrigger timeTrigger(1000,4000);

ESP8266WebServer server ( 80 );

boolean displayOn=false;
OLED display(4, 0);
//LiquidCrystal_I2C lcd(0x27, 16, 2);

uint8_t curPage=0;
//uint8_t sensorsPagesCount=0;

RtcDS3231<TwoWire> rtc(Wire);

//const int sensorBusCount=4;
const int sensorBusCount=3;

String sensorPinDescr[sensorBusCount]={"Pin2","Pin3","Pin4"};
//OneWire oneWires[sensorBusCount]={OneWire(14),OneWire(12),OneWire(13),OneWire(5)};
OneWire oneWires[sensorBusCount]={OneWire(12),OneWire(13),OneWire(5)};
DallasTemperature dallasTemperatures[sensorBusCount];
SensorsDS18_helper sensorHelper;

TimeTrigger sensorTrigger(-5000,10000);
TimeTrigger displayTrigger(0,20000);

const uint8_t ip4=178;

IPAddress localIp(192, 168, 0, ip4);
IPAddress gateIp(192, 168, 0, 1);
IPAddress subnetIp(255, 255, 255, 0);
IPAddress dnsIp(192, 168, 0, 1);
IPAddress dnsIp2(192, 168, 0, 1);

uint8_t refreshInterval=10;

void setup ( void ) {
	DeviceId = "Temp collector1";
	sensorTrigger=TimeTrigger(-5000,refreshInterval);

	Serial.begin ( 115200 );

	dht.begin();

	initDisplay();
	setupButton();
	greenLed.init();
	redLed.init();

	rtc.Begin();

	scanI2C();
	setupWiFi();
	initSensors();

	refreshSensors();
	refreshDisplay();

	displayTrigger.saveTime();

	greenLed.turnOn();
}

void loop ( void ) {
	if(displayTrigger.checkTrigger()){
		Serial.println("  SLeep triggered");
		turnOffDisplay();
		delay(1);
	}
	server.handleClient();
}

void setupButton(){
	//pinMode(okButtonPin, INPUT);
	pinMode(pageButtonPin, INPUT);

	//attachInterrupt(okButtonPin, onOkButtonChanged, CHANGE);
	attachInterrupt(pageButtonPin, onPageButtonChanged,RISING );
	//attachInterrupt(okButtonPin, onOkButtonReleased, FALLING);
}

void clearDisplay(){
	//lcd.clear();
	display.clear();
}

void displayHoldOn(){
	clearDisplay();
	displayLine("Read sensors...", 1,0);
	displayLine("Please wait...", 3,0);
}

void initDisplay(){

	display.begin();
	clearDisplay();

	displayLine("Balabas-soft",1,0);
	displayLine("Loading....",3,0);

	displayTrigger.setActive(true);
	displayOn=true;
}

void turnOnDisplay(){

	  display.on();
	  clearDisplay();
	  displayHoldOn();
	  //display.print("Request sensors...HoldOn");

	//lcd.backlight();
	  displayTrigger.saveTime();
	  displayTrigger.setActive(true);

	displayOn=true;
}

void turnOffDisplay(){

	//lcd.noBacklight();
	displayOn=false;
	displayTrigger.setActive(false);

	display.off();
}

void refreshDisplay(){

	if(displayOn){
		String str;

		char l1[16];
		char l2[16];

		uint8_t sb=curPage-1;
		uint8_t dc=dallasTemperatures[sb].getDeviceCount();

		if(curPage==0){

			/*
			char t[16];
			String time=getTimeStr();
			strcpy(t, time.c_str());
			display.print(t);
			*/
			clearDisplay();
			displayLine("http://",0,0);
			displayLine(WiFi.localIP().toString(),1,0);

			uint8_t sc=getSensorscount()+1;
			str=String(sc)+" sensors";
			displayLine(str,3,0);

			str=" on ("+String(sensorBusCount)+") bus";

			displayLine(str,5,0);

		}else{

			if(sensorTrigger.checkTrigger()){
				displayHoldOn();
				refreshSensors();
			}


			clearDisplay();

			curPage==(sensorBusCount+1){

			}else{

			str=sensorPinDescr[sb];
			if((dc)!=0){
				str+=" (";
				str+=String(dc);
				str+=" sensors) ";
			}else{
				str+=" (NO SENSORS)";
			}
			displayLine(str,0,0);

			str="----------------";
			displayLine(str,1,0);

			if(dc!=0){
				int rov=3;

				for(int j=0;j<dc;j++){
					float val=dallasTemperatures[sb].getTempCByIndex(j);

					char iStr[4];
					char fStr[5];

					sprintf(iStr, "%d", j);
					sprintf(fStr, "%.2f", val);

					str=String(iStr);
					displayLine(str,rov,0);

					str=String(fStr);
					displayLine(str,rov,5);

					rov++;
				}
			}
		}
		}

		Serial.println("Screen refresh complete");
	}

}

void displayLine(String line,uint8_t r,uint8_t c){
	char l[16];
	strcpy(l, line.c_str());
	display.print(l, r,c);
}

void onPageButtonChanged(){
	int button = digitalRead(pageButtonPin);

	  if(button == HIGH)
	  {
		  if(displayOn){
			  if(curPage==(sensorBusCount+1)){
					  curPage=0;
				  }else{
					  curPage++;
				  }
		  }

		  if(curPage>sensorBusCount+1){
			  //hm hov?
			  curPage=0;
		  }

		  if(!displayOn){
			  turnOnDisplay();
		  }

		  Serial.print("CurPage=");
		  Serial.println(curPage);

		  refreshDisplay();

		  displayTrigger.saveTime();
	  }


  return;
}

void onOkButtonChanged(){
	  int button = digitalRead(okButtonPin);
	  if(button == LOW)
	  {
		  displayTrigger.saveTime();
		  displayTrigger.setActive(true);

		  Serial.println("startTimer lastTime=");

	  }else{
		  //if(!display.isOn()){
		  if(!displayOn){
			  turnOnDisplay();

			  refreshDisplay();

			  displayTrigger.saveTime();
		  }
	  }

	  Serial.print("button state changed-----display.isOn()=");
	  Serial.println(displayOn);

	  return;
}

String sensorsToHtml(){
	String html="<table style=\"width: 219px;\" border=\"1\">";

	for(unsigned int i=0;i<sensorBusCount;i++){

		if(dallasTemperatures[i].getDeviceCount()>0){
			html+="<tr>";
			html+="<td style=\"width: 70px;\">Разъем</td>";
			html+="<td style=\"width: 148px;\">";
			html+=sensorPinDescr[i];
			html+="</td>";

			html+="</tr>";
		}


		html+=sensorHelper.sensorToHtml(&dallasTemperatures[i]);
	}

	html+="<tr>";
			html+="<td style=\"width: 70px;\">влажность</td>";
			html+="<td style=\"width: 148px;\">";
			html+=dht.readHumidity(false);
			html+="</td>";
			html+="</tr>";

	html+="<tr>";
			html+="<td style=\"width: 70px;\">температура</td>";
			html+="<td style=\"width: 148px;\">";
			html+=dht.readTemperature(false, false);
			html+="</td>";
			html+="</tr>";

	html+="</table>";

	return html;
}


void refreshSensors(){
	if(sensorTrigger.checkTrigger()){

	for (int i=0;i<sensorBusCount;i++){
		dallasTemperatures[i].requestTemperatures();
	}

	humidity=dht.readHumidity(true);
	temperature=dht.readTemperature(false, true);

		Serial.println("Sensors requested and refreshed");

		sensorTrigger.saveTime();
	}else{
		Serial.println("Sensors requested. Still actual data");
	}
}

int initSensors(){
	int totalSensors=0;

	for(int i=0;i<sensorBusCount;i++){

		dallasTemperatures[i]=DallasTemperature(&oneWires[i]);
		sensorHelper.initSensor(&dallasTemperatures[i], sensorPinDescr[i]);
		uint8_t sOnCDev=dallasTemperatures[i].getDeviceCount();
		totalSensors+=sOnCDev;
		/*
		if(sOnCDev!=0){
			sensorsPagesCount++;
		}
		*/
	}

	Serial.println("Sensors initialized");

	return totalSensors;
}

int getSensorscount(){
	int totalSensors=0;

	for(int i=0;i<sensorBusCount;i++){
		totalSensors+=dallasTemperatures[i].getDeviceCount();
	}

	return totalSensors;
}



void setupWiFi(){



	WiFi.config(localIp,gateIp,subnetIp,dnsIp,dnsIp2);
	//WiFi.enableSTA(true);
	WiFi.begin ( ssid, password );

		Serial.println ( "" );

		// Wait for connection
		while ( WiFi.status() != WL_CONNECTED ) {
			delay ( 500 );
			Serial.print ( "." );
		}

		Serial.println ( "" );
		Serial.print ( "Connected to " );
		Serial.println ( ssid );
		Serial.print ( "IP address: " );
		Serial.println ( WiFi.localIP() );

		if ( MDNS.begin ( "esp8266" ) ) {
			Serial.println ( "MDNS responder started" );
		}



		server.on ( "/", handleRoot );
		server.on ( "/getJson", handleJson );
		server.on ( "/settings", handleSettings );
		server.on ( "/test.svg", drawGraph );
		server.on ( "/inline", []() {
			server.send ( 200, "text/plain", "this works as well" );
		} );
		server.onNotFound ( handleNotFound );
		server.begin();
		Serial.println ( "HTTP server started" );

		Serial.print("Status=");
		Serial.println(WiFi.status());
		Serial.print(" Mac=");
		Serial.println(WiFi.macAddress());

}

char* getDateTimeStr(){
	char str[15];

	RtcDateTime dt= rtc.GetDateTime();
	sprintf(str, "%d-%d-%d %d:%d:%d",     //%d allows to print an integer to the string
		 dt.Year(),   //get year method
		 dt.Month(),  //get month method
		 dt.Day(),
		 dt.Hour(),   //get hour method
		 dt.Minute(), //get minute method
		 dt.Second()//get second method
		 );

	//Serial.println(str);

	return str;
}

String getDateStrMinus(){
	char str[11];

	RtcDateTime dt= rtc.GetDateTime();
	sprintf(str, "%d-%02d-%02d",     //%d allows to print an integer to the string
		 dt.Year(),   //get year method
		 dt.Month(),  //get month method
		 dt.Day()  //get second method
		 );

	//Serial.println(str);

	return String(str);
}

String getDateStr(){
	char str[11];

	RtcDateTime dt= rtc.GetDateTime();
	sprintf(str, "%d/%d/%d",     //%d allows to print an integer to the string
		 dt.Year(),   //get year method
		 dt.Month(),  //get month method
		 dt.Day()  //get second method
		 );

	//Serial.println(str);

	return String(str);
}

String getTimeStr(){
	char str[9];

	RtcDateTime dt= rtc.GetDateTime();
	sprintf(str, "%02d:%02d:%02d",     //%d allows to print an integer to the string
		 dt.Hour(),   //get hour method
		 dt.Minute(), //get minute method
		 dt.Second()  //get second method
		 );

	//Serial.println(str);

	return String(str);
}



void handleRoot() {

	Serial.println("Handle root");
	redLed.changeState();

	refreshSensors();
	refreshDisplay();

	String html="<html>"+getHeader(30);

			html+="<body>\
					<p>\
			<img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAPrSURBVGhD7ZfbSxRxFMd9KQj6G3oJeulBzUu1mqaWZpFlGvVYmd2fkpKIKAWjssIyC42EwAI1y92Ibg8R1UPQhVJTa221hNS1C7a7aunvdM6P2cvo2cWxmW2lOfCB8Tffc8737Mz8ZowywwwzzDDDG/CiepZwWIsIOlaWZ1aIbluGcNjaoNsGBB3TmnI68gO6bPPwCjR6B5iIPIcaRR55Aa0Ns/FXP4xGXdwAgZCGtJSjpEdGCMft1WjsA2c6FJRDuUqZfxei5+Z8NGPlTGqBalAtpWz4Qnyqn4PNSxEPZ2w6UC1ZE2srbYwNvBVyRbe1mzOjB1Sbeijt9A/RdWcBNrnHNTcC6kU9lfZ/H9DfMBccthP4DhjlGhqJ7Im9yYNiZ3ohHM2bcavs5ZqEE/JAXhRbUw/RY12Il/YRV3SqiPdN8NNaoYLWOO1UIU/kTbEZOnD6EuQ3V0gLrjvnoSU6WgWtcVotkDfyqNgNHrgFvuUKaGWw8tCkQWiN02qFPCp2g4cugzis8GV7PvQuXQR9yXGSXkucXKNzbI4GDBnEfa8KnGcPwsizWvn32INK8GxZC66MRBbPlhzUXJADeR5chL7SfbLGxLqh0H8QNGPPy/bdOr2ZqeBasZgdQAVqPqcn+fLs+Ws0XSndB/lRV+Y3kxALP4OY5oYjrT0+xpdPtbgeHLoOIrqaoXNVmjTRSkaWJ6iMegpzYezuOQDUEXTsKVin0vxIS5C5VKNzZaqsyfWaiL5X5CM+0CV7pYmuxEUqg8O78aG235ycg2vDu/JUWsptjY0BZ0XxZH0Q9B1E4XttCfSlxKvMjT+5zGqJ8Sc1Km1faiIMNZxitcEwZBDCFbBLuTeks5pA3Llpfv22HFYTCsMGcRes9xvbnMVqAnFvyvTrMZfThMKQQUafX4XBzCSfMdqhxJvrrJYQr6+pdjHnCgsMPw5+K3LoPoj7fhW0p1igZ7H6YR85toPVEyNHC1Vaym1bgs9JYzmr59B1EGG/Be3LLHLXaouJhqF0vzli9PheEB03/Pr2Rhgt26PSUE4b7lhU413y0il/Het+RQbKi6QJomeJ+qpIspPkdju8E7dcPJ54nnK8+VSL68Gh+yDjnU3QkZHiM/MlWb0Nh4K03rz2tGRZi+vBofsgxDd8j9C30sCZAzDy9Ar8ulSMv76FNS/Bc6T5/bIOvlYfAcfWfFmDqx0MQwbhEK/qwJmfCYP4oqTPEIKOnRuz5K7F5WghbIMQ/Sf3+24dL7TGabUS1kGGmk5PGoTWOK1WwjrIWEu9/KcpEFrjtFoJ6yBGYg4Safxvg1hrUPgwsrHWKHbNMMMMM2ZkREX9Af5QlqKrkORVAAAAAElFTkSuQmCC\">\
			    <h1>Температура    </h1>";
			html+="<h2>";
			html+=DeviceId;
			html+="</h2>";
			html+="</p>";

	html+="<p>";
	html+=sensorsToHtml();
	html+="</p>";
	html+=getTimeFrame();
	html+="</body>\
</html>";

/*	snprintf ( temp, 400,

"<html>\
  <head>\
    <meta http-equiv='refresh' content='5'/>\
    <title>ESP8266 Demo</title>\
    <style>\
      body { background-color: #cccccc; font-family: Arial, Helvetica, Sans-Serif; Color: #000088; }\
    </style>\
  </head>\
  <body>\
    <h1>Hello from ESP8266!</h1>\
    <p>Uptime: %02d:%02d:%02d</p>\
    <img src=\"/test.svg\" />\
  </body>\
</html>",

		hr, min % 60, sec % 60
	);
	*/


	server.send ( 200, "text/html", html );
	redLed.changeState();
}

void handleSettings(){

	 if(!server.authenticate(www_username, www_password)){
		  return server.requestAuthentication();
	 }

	redLed.changeState();

	int argCount=server.args();
			String time="";
			String date="";

			String year="";
			String month="";
			String day="";

			String hour="";
			String minute="";
			String second="";

			String refreshIntervalStr="10000";

			String pinName="";
			String pinValue="";
			String devId="";

			if(argCount!=0){
				time=server.arg("time");
				date=server.arg("date");
				refreshIntervalStr=server.arg("refreshInterval");

				year=date.substring(0, 4);
				month=date.substring(5, 7);
				day=date.substring(8, 10);

				hour=time.substring(0, 2);
				minute=time.substring(3, 5);
				second=time.substring(6, 8);

				devId=server.arg("DeviceId");
				refreshInterval=refreshIntervalStr.toInt();

				sensorTrigger=TimeTrigger(-5000,refreshInterval);

				DeviceId=const_cast<char*>(devId.c_str());
/*
				Serial.println("-------");
				Serial.println(date);
				Serial.println(year);
				Serial.println(month);
				Serial.println(day);
				Serial.println("-------");

				Serial.println("-------");
				Serial.println(time);
				Serial.println(hour);
				Serial.println(minute);
				Serial.println(second);
				Serial.println("-------");
*/
				RtcDateTime dateTime=RtcDateTime(year.toInt(),month.toInt(),day.toInt(),hour.toInt(),minute.toInt(),second.toInt());
				/*Serial.println(dateTime);

				Serial.println(dateTime.Year());
				Serial.println(dateTime.Month());
				Serial.println(dateTime.Day());

				Serial.println(dateTime.Hour());
				Serial.println(dateTime.Minute());
				Serial.println(dateTime.Second());
*/
				rtc.SetDateTime(dateTime);

				for(int i=0;i<sensorBusCount;i++){
					pinName="Pin"+String(i+1)+"Name";
					pinValue=server.arg(pinName);

					if(pinValue.length()!=0){
						sensorPinDescr[i]=pinValue;
					}

				}

			}

		String html="<html>"+getHeader(0);
				  
		html+="<body>\
				<p>\
				<img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAPrSURBVGhD7ZfbSxRxFMd9KQj6G3oJeulBzUu1mqaWZpFlGvVYmd2fkpKIKAWjssIyC42EwAI1y92Ibg8R1UPQhVJTa221hNS1C7a7aunvdM6P2cvo2cWxmW2lOfCB8Tffc8737Mz8ZowywwwzzDDDG/CiepZwWIsIOlaWZ1aIbluGcNjaoNsGBB3TmnI68gO6bPPwCjR6B5iIPIcaRR55Aa0Ns/FXP4xGXdwAgZCGtJSjpEdGCMft1WjsA2c6FJRDuUqZfxei5+Z8NGPlTGqBalAtpWz4Qnyqn4PNSxEPZ2w6UC1ZE2srbYwNvBVyRbe1mzOjB1Sbeijt9A/RdWcBNrnHNTcC6kU9lfZ/H9DfMBccthP4DhjlGhqJ7Im9yYNiZ3ohHM2bcavs5ZqEE/JAXhRbUw/RY12Il/YRV3SqiPdN8NNaoYLWOO1UIU/kTbEZOnD6EuQ3V0gLrjvnoSU6WgWtcVotkDfyqNgNHrgFvuUKaGWw8tCkQWiN02qFPCp2g4cugzis8GV7PvQuXQR9yXGSXkucXKNzbI4GDBnEfa8KnGcPwsizWvn32INK8GxZC66MRBbPlhzUXJADeR5chL7SfbLGxLqh0H8QNGPPy/bdOr2ZqeBasZgdQAVqPqcn+fLs+Ws0XSndB/lRV+Y3kxALP4OY5oYjrT0+xpdPtbgeHLoOIrqaoXNVmjTRSkaWJ6iMegpzYezuOQDUEXTsKVin0vxIS5C5VKNzZaqsyfWaiL5X5CM+0CV7pYmuxEUqg8O78aG235ycg2vDu/JUWsptjY0BZ0XxZH0Q9B1E4XttCfSlxKvMjT+5zGqJ8Sc1Km1faiIMNZxitcEwZBDCFbBLuTeks5pA3Llpfv22HFYTCsMGcRes9xvbnMVqAnFvyvTrMZfThMKQQUafX4XBzCSfMdqhxJvrrJYQr6+pdjHnCgsMPw5+K3LoPoj7fhW0p1igZ7H6YR85toPVEyNHC1Vaym1bgs9JYzmr59B1EGG/Be3LLHLXaouJhqF0vzli9PheEB03/Pr2Rhgt26PSUE4b7lhU413y0il/Het+RQbKi6QJomeJ+qpIspPkdju8E7dcPJ54nnK8+VSL68Gh+yDjnU3QkZHiM/MlWb0Nh4K03rz2tGRZi+vBofsgxDd8j9C30sCZAzDy9Ar8ulSMv76FNS/Bc6T5/bIOvlYfAcfWfFmDqx0MQwbhEK/qwJmfCYP4oqTPEIKOnRuz5K7F5WghbIMQ/Sf3+24dL7TGabUS1kGGmk5PGoTWOK1WwjrIWEu9/KcpEFrjtFoJ6yBGYg4Safxvg1hrUPgwsrHWKHbNMMMMM2ZkREX9Af5QlqKrkORVAAAAAElFTkSuQmCC\">\
				    <h1>Настройки </h1>";
		html+="<h2>";
		html+=DeviceId;
		html+="</h2>";
		html+="</p>";

		html+="<form method=\"POST\" action=\"settings\">\
		          	 <p>\
		          	<table style=\"width: 219px;\">\
		          	<tr>\
		          		<td style=\"width: 70px;\"><h3>Устройство</h3></td>\
		          		<td style=\"width: 148px;\">";
		html+="<input type=\"text\" name=\"DeviceId\" value=\"";
		html+=DeviceId;
		html+="\"></td>\
		          	</tr>\
		          	<tr>\
		          		<td style=\"width: 70px;\"><h3>Время</h3></td>\
		          		<td style=\"width: 148px;\"><input type=\"time\" name=\"time\" value=\"";
		html+=getTimeStr();
		html+="\"></td>\
		          	</tr>";
		html+="<tr>\
			<td style=\"width: 70px;\"><h3>Дата</h3></td>\
			<td style=\"width: 148px;\"><input type=\"date\" name=\"date\" value=\"";
			html+=getDateStrMinus();
			html+="\"></td>\
			</tr>";

		html+="<tr>\
			<td style=\"width: 70px;\"><h3>Интервал опроса</h3></td>\
			<td style=\"width: 148px;\"><input type=\"refreshInterval\" name=\"refreshInterval\" value=\"";
			html+=refreshInterval;
			html+="\"></td>\
			</tr>";



		for(int i=0;i<sensorBusCount;i++){

			pinName="Pin"+String(i+1)+"Name";
			pinValue=sensorPinDescr[i];
			html+="<tr>\
	          		<td style=\"width: 70px;\"><h3>";
			html+=pinName;
			html+="</h3></td>\
	          		<td style=\"width: 148px;\"><input type=\"text\" name=\"";
			html+=pinName;
			html+="\" value=\"";
			html+=pinValue;
			html+="\"></td>\
	          	</tr>";
		}

		    html+="</table>\
		          	 </p>\
		          		<input type=\"submit\" name=\"Сохранить\" value=\"Сохранить\">\
		          	</form>\
		          </p>";


		html+="</p>";
		html+=getTimeFrame();
		html+="</body></html>";

	server.send ( 200, "text/html", html );
	redLed.changeState();
}

String getHeader(int refreshTime){
	String html="<head>";
	if(refreshTime!=0){
		html+="<meta http-equiv='refresh' content='";
		html+=String(refreshTime);
		html+="'/>";
	}

	html+="<meta charset=\"utf-8\">\
    <title>balabas-soft sensors ESP8266 </title>\
    <style>\
      body { background-color: #cccccc; font-family: Arial, Helvetica, Sans-Serif; Color: #000088; }\
    </style>\
  </head>";

	return html;
}

String getTimeFrame(){
	String html="<p>";
	html+="Последнее время измерения:  ";
	html+=getDateStr()+" " +getTimeStr();
	html+="</p>";
	html+="<p>";
	html+="MAC адресс:  ";
	html+=WiFi.macAddress();
	html+="</p>";

	return html;
}

void handleJson(){
	Serial.println("Handle Json");
	refreshSensors();

	String result="{\"device\":\"";
	result+=String(DeviceId);
	result+="\",\"date\":\"";
	result+=getDateStr();
	result+="\",\"time\": \"";
	result+=getTimeStr();
	result+="\",\"count\":";
	result+=String(getSensorscount());
	result+=",\"sensors\": [";

	for(unsigned int i=0;i<sensorBusCount;i++){
		//result+=sensorHelper.sensorToJson(&dallasTemperatures[i],getDateStr(),getTimeStr(),DeviceId);
		int length=dallasTemperatures[i].getDeviceCount();

		for(int j=0;j<length;j++){
			result+="{\"id\":";
			result+=String(j);
			result+=",\"value\":";
			result+=dallasTemperatures[i].getTempCByIndex(j);
			result+="}";
			if(j!=length-1){
				result+=",";
			}
		}

		if(i!=sensorBusCount-1){
			result+=",";
		}
	}

	result+="]}";

	server.send ( 200, "text/html", result );
}

void handleNotFound() {
	redLed.changeState();
	String message = "File Not Found\n\n";
	message += "URI: ";
	message += server.uri();
	message += "\nMethod: ";
	message += ( server.method() == HTTP_GET ) ? "GET" : "POST";
	message += "\nArguments: ";
	message += server.args();
	message += "\n";

	for ( uint8_t i = 0; i < server.args(); i++ ) {
		message += " " + server.argName ( i ) + ": " + server.arg ( i ) + "\n";
	}

	server.send ( 404, "text/plain", message );
	redLed.changeState();
}

void drawGraph() {
	String out = "";
	char temp[100];
	out += "<svg xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\" width=\"400\" height=\"150\">\n";
 	out += "<rect width=\"400\" height=\"150\" fill=\"rgb(250, 230, 210)\" stroke-width=\"1\" stroke=\"rgb(0, 0, 0)\" />\n";
 	out += "<g stroke=\"black\">\n";
 	int y = rand() % 130;
 	for (int x = 10; x < 390; x+= 10) {
 		int y2 = rand() % 130;
 		sprintf(temp, "<line x1=\"%d\" y1=\"%d\" x2=\"%d\" y2=\"%d\" stroke-width=\"1\" />\n", x, 140 - y, x + 10, 140 - y2);
 		out += temp;
 		y = y2;
 	}
	out += "</g>\n</svg>\n";

	server.send ( 200, "image/svg+xml", out);

}

void scanI2C(){
	 Wire.begin();

	 byte error, address;
	  int nDevices;

	  Serial.println("Scanning...");

	  nDevices = 0;
	  for(address = 1; address < 127; address++ )
	  {

	    Wire.beginTransmission(address);
	    error = Wire.endTransmission();

	    if (error == 0)
	    {
	      Serial.print("I2C device found at address 0x");
	      if (address<16)
	        Serial.print("0");
	      Serial.print(address,HEX);
	      Serial.println("  !");

	      nDevices++;
	    }
	    else if (error==4)
	    {
	      Serial.print("Unknow error at address 0x");
	      if (address<16)
	        Serial.print("0");
	      Serial.println(address,HEX);
	    }
	  }
	  if (nDevices == 0)
	    Serial.println("No I2C devices found\n");
	  else
	    Serial.println("done\n");

	  delay(5000);
}

/*
void setupDisplay(){

	Serial.println("OLED test!");

	  display.print("Hello World");
	  delay(3*1000);

	  display.print("Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.");
	  delay(3*1000);

	  display.clear();
	  delay(3*1000);

	  display.print("TOP-LEFT");
	  display.print("4th row", 4);
	  display.print("RIGHT-BOTTOM", 7, 4);
	  delay(3*1000);

	  display.off();
	  display.print("3rd row", 3, 8);
	  delay(3*1000);

	  display.on();
	  delay(3*1000);
}

void printSensorsToOled(){

	char t[16];
	String time=getTimeStr();
	strcpy(t, time.c_str());
	//display.print(t);

	//int count=getSensorscount();
	String addr=WiFi.localIP().toString();
	char a[16];
	strcpy(a, addr.c_str());
	//display.print(a,1);

	int n=2;

	for (int i=0;i<sensorBusCount;i++){
		for(int j=0;j<dallasTemperatures[i].getDeviceCount();j++){
			float val=dallasTemperatures[i].getTempCByIndex(j);

			char iStr[4];
			char fStr[5];

			sprintf(iStr, "%d", n);
			sprintf(fStr, "%.2f", val);

			//display.print(iStr, n);
			//display.print(fStr, n,2);

			n++;
		}
	}

}

*/


