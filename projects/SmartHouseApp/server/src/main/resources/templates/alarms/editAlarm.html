<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
<title th:text="${pageHeader}">Устройство</title>
<th:block th:replace="templates :: headImportsUp" ></th:block>

</head>

<body>

<header th:replace="templates :: MainPageHeader(url=${baseUrl + '/virtual/devices'}, text=${'Тревога'})"></header>

	<div class="container">
		<h4 th:text="${pageHeader}"></h4>

		<form action="#" th:action="@{/save{path}Alarm(path=${alarm.targetItemClass.getSimpleName()})}" th:object="${alarm}"
			method="post">
			<input type="hidden" th:field="*{id}">
			<table class="table table-dark table-striped">
				<tr>
					<td th:text="${alarm.targetItemClass.getSimpleName()}"></td>
					<td th:text="${alarm.getPreviousAlarmState().getEmoji().toString() + ' -> ' + alarm.getAlarmState().getEmoji().toString()}">itemClass</td>
				</tr>
				<tr>
					<td>Описание</td>
					<td><input type="text" th:field="*{description}"></td>
				</tr>
				<tr>
					<td>Параметр</td>
					<td><input type="text" th:field="*{parameter}"></td>
				</tr>
				<tr>
					<td>Интервал</td>
					<td><input type="number" th:field="*{messageInterval}"></td>
				</tr>
				
				<tr>
					<td>Процессор</td>
					<td>
						<select th:field="*{checkerName}">
								<option th:each="checker : ${checkers}"
									th:value="${checker.getName()}"
									th:utext="${checker.getName() + ' - ' + checker.getCheckerDescription()}"
									th:selected="${checker.getName().equals(currentCheckerName)}"/>
						</select>
					</td>
				</tr>
				
				<tr>
					<td>Цель процессинга</td>
					<td>
						<select th:name="targetId">
								<option th:each="target : ${targets}"
									th:value="${target.id}"
									th:utext="${target.description}"
									th:selected="${target.isIdEqual(alarm.getItemId())}"/>
						</select>
					</td>
				</tr>
			</table>

			<div th:if="${!alarm.isNew()}">
				
				<h4>События</h4>			
				<button type="button" class="btn btn-default" data-toggle="modal"
									th:attr="data-target='#addAlarmEventModal' + ${alarm.id}">Новое событие</button>
									
				<table class="table table-dark table-striped">
					<thead>
						<tr>
						    <th></th>
							<th>Описание</th>
							<th>Состояние 1</th>
							<th>Состояние 2</th>
							<th>Строка</th>
							<th>Параметры строки</th>
							<th>Процессор событий</th>
							<th>Показатель цель</th>
							<th></th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="actionItem : ${alarm.getActionsList()}">
						    <td th:text="${actionItem.getEmoji()}"></td>
							<td th:text="${actionItem.description}"></td>
							<td th:text="${actionItem.getOldState()}"></td>
							<td th:text="${actionItem.getNewState()}"></td>
							<td th:text="${actionItem.stringFormatted}"></td>
							<td th:text="${actionItem.stringParametersFormatted}"></td>
							<td th:text="${actionItem.targetBeanName}"></td>
							<td th:text="${actionItem.targetFieldId}"></td>
							
							<td>
								<a th:href="@{~/deleteAction?id={id}&alarmId={alarmId}&itemType={itemType}(id=${actionItem.id}, alarmId=${alarm.id}, itemType=${itemType})}"
									class="btn btn-default">Удалить</a>
							</td>
						</tr>
					</tbody>
				</table>
			</div>

			<div>
				<input type="submit" class="btn btn-default" value="&#x1F4BE; Сохранить" />
				<a th:href="@{~/alarmsList}" class="btn btn-default">&#x274C; Отменить</a>
			</div>

		</form>
		
		<div class="modal fade" th:id="'addAlarmEventModal' + ${alarm.id}">
			<div class="modal-dialog">
				<div class="modal-content">

					<!-- Modal Header -->
					<div class="modal-header">
						<button type="button" class="close"
							data-dismiss="modal">&times;</button>
						<h4 class="modal-title">Добавить событие</h4>
					</div>

					<form th:if="${!alarm.isNew()}" th:action="@{/saveAlarmEvent}" th:object="${alarmEvent}"
						method="post">
						<input type="hidden" name="alarmId" th:value="${alarm.id}">
						<input type="hidden" name="itemType" th:value="${itemType}">
						<input type="hidden" th:field="*{id}">
						<table class="table table-dark table-striped">
							<tr>
								<td>Имя</td>
								<td><input type="text" th:field="*{name}"></td>
							</tr>
						    <tr>
								<td>Описание</td>
								<td><input type="text" th:field="*{description}"></td>
							</tr>
							<tr>
								<td>Емоджи</td>
								<td>
									<select name="emojiName">
											<option th:each="emoji : ${emojies}"
												th:value="${emoji}"
												th:utext="${emoji}"
												th:selected="${alarmEvent.getEmoji().equals(emoji)}"/>
									</select>
								</td>
							</tr>
							<tr>
								<td>Старое состояние</td>
								<td>
									<select name="oldStateName">
											<option th:each="state : ${alarmStates}"
												th:value="${state.getName()}"
												th:utext="${state.getName()}"
												th:selected="${state.equals(alarmEvent.oldState)}"/>
									</select>
								</td>
							</tr>
							<tr>
								<td>Новое состояние</td>
								<td>
									<select name="newStateName">
											<option th:each="state : ${alarmStates}"
												th:value="${state.getName()}"
												th:utext="${state.getName()}"
												th:selected="${state.equals(alarmEvent.newState)}"/>
									</select>
								</td>
							</tr>
							<tr>
								<td>Процессор</td>
								<td>
									<select th:field="*{targetBeanName}">
											<option th:each="processor : ${alarmStateChangedEventProcessors}"
												th:value="${processor.getName()}"
												th:utext="${processor.getName() + ' - ' + processor.getProcessorDescription()}"
												th:selected="${processor.getName().equalsIgnoreCase(alarmEvent.targetBeanName)}"/>
									</select>
								</td>
							</tr>
							<tr>
								<td>Параметр</td>
								<td><input type="text" th:field="*{parameter}"></td>
							</tr>
							<tr>
								<td>Поле цель</td>
								<td>
									<select th:field="*{targetFieldId}">
										<option value=null>Не задано</option> 
										<option th:each="targetField : ${targetFields}"
											th:value="${targetField.id}"
											th:utext="${targetField.getFullName()}"
											th:selected="${targetField.id.equals(alarmEvent.targetFieldId)}"/>
									</select>
								</td>
							</tr>
							<tr>
								<td>Строка-сообщение</td>
								<td>
									<input type="text" th:field="*{stringFormatted}">
								</td>
							</tr>
							<tr>
								<td>Параметры строки-сообщения</td>
								<td>
									<input type="text" th:field="*{stringParametersFormatted}">
								</td>
							</tr>
							<tr>
								<td>Подсказка</td>
								<td th:text="*{hint}">
								</td>
							</tr>
							<tr>
								<td>dispatchIfSameState</td>
								<td>
									<input type="checkbox" th:field="*{dispatchIfSameState}">
								</td>
								<td>Интервал</td>
								<td>
									<input type="number" th:field="*{interval}">
								</td>
							</tr>
						</table>
						<div class="modal-footer">
							<input type="submit" class="btn btn-default" value="&#x1F4BE; Сохранить" />
						</div>
					</form>
					<!-- Modal footer -->
				</div>
			</div>
		</div>
		
		
	</div>

	<footer th:replace="templates :: footer"></footer>
	<div th:replace="templates :: importsUp" th:remove="tag"></div>
</body>

</html>