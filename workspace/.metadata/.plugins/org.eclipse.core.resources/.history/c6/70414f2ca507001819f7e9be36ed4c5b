#include <ESP8266WiFi.h>
#include <WiFiClient.h>
#include <ESP8266WebServer.h>
#include <ESP8266mDNS.h>

#include <Wire.h>
#include "OLED.h"

#include "LiquidCrystal_I2C.h"

#include <OneWire.h>
#include "DallasTemperature.h"
#include "BeeperB.h"
#include "ButtonB.h"
#include "LedB.h"
#include "TimeTrigger.h"
#include <RtcDS3231.h>
#include "SensorsDS18_helper.h"
#include "DHT.h"
//#include "EEPROM.h"
#include "FS.h"
#include "KeyValue.h"
#include "WiFiSettContainer.h"

const String KEY_PREFFIX="key_SR_";
const String SETT_PREFFIX="sett_SR_";

const uint8_t okButtonPin=13;
const uint8_t pageButtonPin=2;

const uint8_t am2301Pin=14;
#define DHTTYPE DHT21   // DHT 21 (AM2301)
DHT dht(am2301Pin, DHTTYPE);
float humidity;
float temperature;

String dhtName="pin_D14";
String dhtHumidityAddress="dht_hum_addr";
String dhtTemperatureAddress="dht_temp_addr";

LedB greenLed(9);
LedB redLed(10);
//BeeperB beeper(5);

TimeTrigger timeTrigger(1000,4000);

ESP8266WebServer server ( 80 );

//boolean displayAlvaysOn=false;
boolean displayOn=false;
OLED display(4, 0);
//LiquidCrystal_I2C lcd(0x27, 16, 2);

uint8_t curPage=0;
//uint8_t sensorsPagesCount=0;

RtcDS3231<TwoWire> rtc(Wire);

//const int sensorBusCount=4;
const int sensorBusCount=2;

String sensorPinDescr[sensorBusCount]={"Pin_D12","Pin_D5"};
//OneWire oneWires[sensorBusCount]={OneWire(14),OneWire(12),OneWire(13),OneWire(5)};
OneWire oneWires[sensorBusCount]={OneWire(12),OneWire(5)};
DallasTemperature dallasTemperatures[sensorBusCount];
SensorsDS18_helper sensorHelper;

uint8_t totalDetectedSensors=0;
uint8_t totalActivePages=0;

boolean activePages[sensorBusCount+2]={true,false,false,false};
boolean haveActivePages=false;

boolean pageButtonHandleInLoop=false;

TimeTrigger sensorTrigger(-5000,10000);
TimeTrigger displayTrigger(0,20000);

//uint8_t refreshInterval=10;

KeyValueContainer sensorsKVContainer("/sensors.txt");
KeyValueContainer settingsKVContainer("/values.txt");

WiFiSettContainer wiFiSettContainer(&settingsKVContainer);

void setup ( void ) {
	//DeviceId = "Temp collector1";
	//dhtHumidityAddress=String(ESP.getChipId()) + "hum1";
	//dhtTemperatureAddress=String(ESP.getChipId()) + "temp1";
	Serial.begin ( 115200 );

	initDisplay();
	initFS();

	initializeSettings();

	sensorTrigger=TimeTrigger(-5000,wiFiSettContainer.refreshInterval*1000);

	greenLed.init();
	redLed.init();
	rtc.Begin();
	scanI2C();

	setupButtons();
	setupButtonInterrupts();

	setupWiFi();
	initSensors();

	sensorsKVContainer.saveToFile(false);
	sensorsKVContainer.loadFromFile();

	refreshSensors();
	refreshDisplay();

	displayTrigger.saveTime();

	greenLed.turnOn();
}

void loop ( void ) {
	handlePageButton();
	handleDisplayPover();

	server.handleClient();
}

void initializeSettings(){
	delay(500);
	int button = digitalRead(pageButtonPin);

	if(button == HIGH)
	{
		Serial.println("---STart access point -----2");
		wiFiSettContainer.putDefaultValuesToContainer();

		//wiFiSettContainer.DeviceId="ESP_Setup"+String(ESP.getChipId());
		//wiFiSettContainer.isAccesPoint=true;
		wiFiSettContainer.saveVariablesToFile();
		/*wiFiSettContainer.saveSettingsToFile(true);*/
		clearDisplay();
		displayLine("SoftAP mode",3,0);
		delay(500);
		Serial.println("Station vill vork as station");

		Serial.println("access point conf done");
	}else{
		//wiFiSettContainer.loadSettingsFromFile();
		clearDisplay();
		displayLine("Loading device",3,0);
	}

	Serial.println("-----Stat load variables from file");

	wiFiSettContainer.loadVariablesFromFile();
	wiFiSettContainer.putFromVariablesToContainer();

	Serial.println("------Variables load complete");

	delay(500);
}

void setupButtons(){
	//pinMode(okButtonPin, INPUT);
	pinMode(pageButtonPin, INPUT);
}

void setupButtonInterrupts(){
	//attachInterrupt(okButtonPin, onOkButtonChanged, CHANGE);
	attachInterrupt(pageButtonPin, onPageButtonChanged,RISING );
	//attachInterrupt(okButtonPin, onOkButtonReleased, FALLING);
}

void clearDisplay(){
	//lcd.clear();
	display.clear();
}

void displayHoldOn(){
	clearDisplay();
	displayLine("Read sensors...", 1,0);
	displayLine("Please wait...", 3,0);
}

void initFS(){
	bool result = SPIFFS.begin();
	Serial.println("SPIFFS opened: " + result);
}

void initDisplay(){

	display.begin();
	clearDisplay();

	displayLine("Balabas-soft",1,0);
	displayLine("Loading....",3,0);
	displayLine("Hold Button to",5,0);
	displayLine("reset device",6,0);

	displayTrigger.setActive(true);
	displayOn=true;
}

void turnOnDisplay(){

	  display.on();
	  clearDisplay();
	  displayHoldOn();
	  //display.print("Request sensors...HoldOn");

	//lcd.backlight();
	  displayTrigger.saveTime();
	  displayTrigger.setActive(true);

	displayOn=true;
}

void turnOffDisplay(){

	if(!wiFiSettContainer.displayAlvaysOn){
		displayOn=false;
		displayTrigger.setActive(false);

		display.off();
	}
}

void refreshDisplay(){

	if(displayOn){
		String str;

		//char l1[16];
		//char l2[16];

		uint8_t sb=curPage-1;
		uint8_t dc=dallasTemperatures[sb].getDeviceCount();

		if(curPage==0){

			clearDisplay();


			if(!wiFiSettContainer.isAccesPoint){
				displayLine("http://",0,0);
				displayLine(WiFi.localIP().toString(),1,0);

				uint8_t sc=totalDetectedSensors;
				str=String(sc)+" sensors";
				displayLine(str,3,0);

				str=" on ("+String(totalActivePages)+") pages";

				displayLine(str,5,0);
			}else{
				String ipLine="IP="+WiFi.softAPIP().toString();

				Serial.println(WiFi.softAPIP());
				Serial.println(ipLine);

				displayLine("SETUP MODE",0,0);
				displayLine("CONNECT AND SET",1,0);
				displayLine(ipLine,3,0);
				displayLine("PORT=80",5,0);
			}

		}else{

			if(sensorTrigger.checkTrigger()){
				displayHoldOn();
				refreshSensors();
			}


			clearDisplay();

			if(curPage==(sensorBusCount+1)){
				//DHT sensor

				str=String(DHTTYPE);
				displayLine(str,0,0);

				str="----------------";
				displayLine(str,1,0);

				str="Hum: "+String(dht.readHumidity(false));
				displayLine(str,3,0);

				str="Temp:"+String(dht.readTemperature(false, false));
				displayLine(str,5,0);
			}else{
				//OneWire sensors
			str=sensorPinDescr[sb];
			if((dc)!=0){
				str+=" (";
				str+=String(dc);
				str+=" sensors) ";
			}else{
				str+=" (NO SENSORS)";
			}
			displayLine(str,0,0);

			str="----------------";
			displayLine(str,1,0);

			if(dc!=0){
				int rov=3;

				for(int j=0;j<dc;j++){
					float val=dallasTemperatures[sb].getTempCByIndex(j);

					char iStr[4];
					char fStr[5];

					sprintf(iStr, "%d", j);
					sprintf(fStr, "%.2f", val);

					str=String(iStr);
					displayLine(str,rov,0);


					str=String(fStr);
					displayLine(str,rov,5);

					rov++;
				}
			}
		}
		}

		Serial.println("Screen refresh complete");
	}

}

void displayLine(String line,uint8_t r,uint8_t c){
	char l[16];
	strcpy(l, line.c_str());
	display.print(l, r,c);
/*
	Serial.print("display.print(line,rov,column)=(");
	Serial.print(line);
	Serial.print(",");
	Serial.print(r);
	Serial.print(",");
	Serial.print(c);
	Serial.println(")");
	*/
}

void onPageButtonChanged(){
	int button = digitalRead(pageButtonPin);

	  if(button == HIGH)
	  {
		  pageButtonHandleInLoop=true;

	  }

  return;
}

void handlePageButton(){
	if(pageButtonHandleInLoop){
		if(wiFiSettContainer.displayAlvaysOn){
			displayOn=true;
			turnOnDisplay();
		}

		 if(displayOn){
			  curPage=getNextActivePage();
		  }

		  if(curPage>getMaxPossPage()){
			  //hm hov?
			  curPage=0;
		  }

		  if(!displayOn){
			  turnOnDisplay();
		  }

		  Serial.print("CurPage=");
		  Serial.println(curPage);

		  refreshDisplay();

		  displayTrigger.saveTime();

		  pageButtonHandleInLoop=false;
	}
}

void handleDisplayPover(){
	if(!wiFiSettContainer.displayAlvaysOn){
		if(displayTrigger.checkTrigger()){
			Serial.println("  SLeep triggered");
			turnOffDisplay();
			delay(1);
		}
	}
}

uint8_t getMaxPossPage(){
	uint8_t result=sensorBusCount+1;
/*
	Serial.print("getMaxPossPage()=");
	Serial.println(result);
*/
	return result;
}

uint8_t getNextActivePage(){
	uint8_t maxPossiblePage=getMaxPossPage();
/*
	Serial.print("curPageIn=");
	Serial.print(curPage);
	Serial.print(";");
*/
	if(totalDetectedSensors==0 || curPage==maxPossiblePage){
		Serial.println("totalDetectedSensors==0 || curPageIn==maxPossiblePage");
		return 0;
	}

	for(uint8_t i=curPage+1;i<=maxPossiblePage;i++){
		if(activePages[i]){
			/*
			Serial.print("Next non Empty page=");
			Serial.print(i);
			*/
			return i;
		}
	}

	return 0;
}

void onOkButtonChanged(){
	  int button = digitalRead(okButtonPin);
	  if(button == LOW)
	  {
		  displayTrigger.saveTime();
		  displayTrigger.setActive(true);

		  Serial.println("startTimer lastTime=");

	  }else{
		  //if(!display.isOn()){
		  if(!displayOn){
			  turnOnDisplay();

			  refreshDisplay();

			  displayTrigger.saveTime();
		  }
	  }

	  Serial.print("button state changed-----display.isOn()=");
	  Serial.println(displayOn);

	  return;
}

String sensorsToHtml(){
	String html="<table style=\"width: 219px;\" border=\"1\">";

	for(unsigned int i=0;i<sensorBusCount;i++){

		if(dallasTemperatures[i].getDeviceCount()>0){
			html+="<tr>";
			html+="<td style=\"width: 70px;\">";
			html+="</td>";
			html+="<td style=\"width: 148px;\">";
			html+=sensorHelper.getValueByKey(dallasTemperatures[i].getDescription());
			html+="</td>";
			html+="<td style=\"width: 148px;\">";
			html+="</td>";
			html+="</tr>";
		}


		html+=sensorHelper.sensorToHtml(&dallasTemperatures[i]);
	}

	html+="<tr>";
			html+="<td style=\"width: 70px;\"></td>";
			html+="<td style=\"width: 148px;\">";
			html+=sensorHelper.getValueByKey(dhtName);
			html+="<td style=\"width: 148px;\">";
			html+="</td>";
			html+="</tr>";

	html+="<tr>";
			html+="<td style=\"width: 70px;\">";
			html+=sensorHelper.getValueByKey(dhtHumidityAddress);
			html+="</td>";
			html+="<td style=\"width: 148px;\">";
			html+=dht.readHumidity(true);
			html+="</td>";
			html+="<td style=\"width: 148px;\">";
			html+="</td>";
			html+="</tr>";

	html+="<tr>";
			html+="<td style=\"width: 70px;\">";
			html+=sensorHelper.getValueByKey(dhtTemperatureAddress);
			html+="</td>";
			html+="<td style=\"width: 148px;\">";
			html+=dht.readTemperature(false, true);
			html+="</td>";
			html+="<td style=\"width: 148px;\">";
			html+="</td>";
			html+="</tr>";

	html+="</table>";

	return html;
}


void refreshSensors(){
	if(sensorTrigger.checkTrigger()){

	for (int i=0;i<sensorBusCount;i++){
		dallasTemperatures[i].requestTemperatures();
	}

	unsigned long startTime=millis();
	boolean timeOut=false;

	while(!timeOut){
		humidity=dht.readHumidity(true);

		timeOut=!isnan(humidity);

		if(!timeOut && (startTime+5000>millis())){
			timeOut=true;
		}

		if(!timeOut){
			delay(1000);
		}
	}

	startTime=millis();
	timeOut=false;

	while(!timeOut){

		temperature=dht.readTemperature(false, true);

		timeOut=!isnan(temperature);

		if(!timeOut && (startTime+5000>millis())){
			timeOut=true;
		}

		if(!timeOut){
			delay(1000);
		}

	}


		Serial.println("Sensors requested and refreshed");

		sensorTrigger.saveTime();
	}else{
		Serial.println("Sensors requested. Still actual data");
	}
}

int initSensors(){

	sensorHelper.setKeyValueContainer(&sensorsKVContainer);

	uint8_t totalOneVireSensors=0;
	uint8_t totalDHTSensors=0;

	//OneVire section
	for(int i=0;i<sensorBusCount;i++){

		dallasTemperatures[i]=DallasTemperature(&oneWires[i]);
		sensorHelper.initSensor(&dallasTemperatures[i], sensorPinDescr[i]);
		uint8_t sOnCDev=dallasTemperatures[i].getDeviceCount();
		totalOneVireSensors+=sOnCDev;

		if(sOnCDev!=0){
			sensorHelper.putKeyValue(sensorPinDescr[i], sensorPinDescr[i]+"_value");

			activePages[i+1]=true;
			totalActivePages++;

			for(uint8_t j=0;j<sOnCDev;j++){
				String deviceAddressD=sensorHelper.
						getSensorAddressByIndexStr(&dallasTemperatures[i], j);

				sensorHelper.putKeyValue(deviceAddressD, deviceAddressD+"_value");
			}
		}
	}

	//DHT section

	dht.begin();
	boolean dhtActive=dht.read(true);

	if(dhtActive){

		sensorHelper.putKeyValue(dhtName, dhtName+"_value");
		sensorHelper.putKeyValue(dhtHumidityAddress, dhtHumidityAddress+"_value");
		sensorHelper.putKeyValue(dhtTemperatureAddress, dhtTemperatureAddress+"_value");

		activePages[sensorBusCount+1]=true;
		totalDHTSensors++;
		totalActivePages++;
	}

	totalDetectedSensors=totalOneVireSensors+totalDHTSensors;

	Serial.println("Sensors initialized");
	Serial.print("OneVire count=");
	Serial.println(totalOneVireSensors);
	Serial.print("DHT count=");
	Serial.println(totalDHTSensors);
	Serial.print("totalDetectedSensors=");
	Serial.println(totalDetectedSensors);
	Serial.print("totalActivePages=");
	Serial.println(totalActivePages);
	Serial.print("activePages={");
	for(uint8_t i=0;i<sizeof(activePages);i++){
		Serial.print(activePages[i]);
		if(i!=sizeof(activePages)-1){
			Serial.print(",");
		}
	}
	Serial.println("}");

	Serial.println("------------------------------");

	return totalDetectedSensors;
}


int getSensorscount(){
	int totalSensors=0;

	for(int i=0;i<sensorBusCount;i++){
		totalSensors+=dallasTemperatures[i].getDeviceCount();
	}

	return totalSensors;
}

void setupWiFi(){
	/*String str=read_string_EEPROM(0);

	Serial.println("-----");
	Serial.println(str);
	Serial.println(str.length());
	Serial.println("-----");

	 String esid=getDataFromEeprom(0,32);
	  Serial.print("SSID: ");
	  Serial.println(esid);
	  String epass = getDataFromEeprom(32,96);
	  Serial.print("PASS: ");
	  Serial.println(epass);

	  String username = getDataFromEeprom(96,128);
	  Serial.print("username: ");
	  Serial.println(username);

	  String pass = getDataFromEeprom(128,160);
	  Serial.print("password: ");
	  Serial.println(pass);
*/
	Serial.println("CHecking is access point");
	if(wiFiSettContainer.isAccesPoint){
		//WiFi.mode(WIFI_AP);
		Serial.println("STarting as access point");
		/*
		 WiFi.softAPConfig(wiFiSettContainer.apIp,wiFiSettContainer.gateIp,
				wiFiSettContainer.subnetIp);
				*/
		//WiFi.softAP(const_cast<char*>(wiFiSettContainer.ssidAP.c_str()),const_cast<char*>(wiFiSettContainer.passwordAP.c_str()));
		//WiFi.softAP(const_cast<char*>(wiFiSettContainer.ssidAP.c_str()));
		//String apName="ESP "+ESP.getChipId();
		WiFi.softAP("ESP_Sensors");

		Serial.println ( "-----------" );
		Serial.print ( "SoftAP " );
		Serial.println ( wiFiSettContainer.ssidAP);
		Serial.print ( "IP address: " );
		Serial.println ( WiFi.softAPIP() );
		Serial.println ( "-----------" );

		Serial.print("ViFi status");
		Serial.println(WiFi.status());
		Serial.println ( "-----------" );

	}else{
		WiFi.config(wiFiSettContainer.localIp,wiFiSettContainer.gateIp,
				wiFiSettContainer.subnetIp,wiFiSettContainer.dnsIp,wiFiSettContainer.dnsIp2);
		WiFi.begin ( const_cast<char*>(wiFiSettContainer.ssid.c_str()),
				const_cast<char*>(wiFiSettContainer.password.c_str()) );

		// Wait for connection
		while ( WiFi.status() != WL_CONNECTED ) {
			delay ( 500 );
			Serial.print ( "." );
		}

		Serial.println ( "" );
		Serial.print ( "Connected to " );
		Serial.println ( WiFi.SSID() );
		Serial.print ( "IP address: " );
		Serial.println ( WiFi.localIP() );

		if ( MDNS.begin ( "esp8266" ) ) {
			Serial.println ( "MDNS responder started" );
		}
	}


		Serial.println ( "" );


		server.on ( "/", handleRoot );
		server.on ( "/getJson", handleJson );
		server.on ( "/settings", handleSettings );
		server.on ( "/test.svg", drawGraph );
		server.on ( "/inline", []() {
			server.send ( 200, "text/plain", "this works as well" );
		} );
		server.onNotFound ( handleNotFound );
		server.begin();
		Serial.println ( "HTTP server started" );

		Serial.print("Status=");
		Serial.println(WiFi.status());
		Serial.print(" Mac=");
		Serial.println(WiFi.macAddress());

}

char* getDateTimeStr(){
	char str[15];

	RtcDateTime dt= rtc.GetDateTime();
	sprintf(str, "%d-%d-%d %d:%d:%d",     //%d allows to print an integer to the string
		 dt.Year(),   //get year method
		 dt.Month(),  //get month method
		 dt.Day(),
		 dt.Hour(),   //get hour method
		 dt.Minute(), //get minute method
		 dt.Second()//get second method
		 );

	//Serial.println(str);

	return str;
}

String getDateStrMinus(){
	char str[11];

	RtcDateTime dt= rtc.GetDateTime();
	sprintf(str, "%d-%02d-%02d",     //%d allows to print an integer to the string
		 dt.Year(),   //get year method
		 dt.Month(),  //get month method
		 dt.Day()  //get second method
		 );

	//Serial.println(str);

	return String(str);
}

String getDateStr(){
	char str[11];

	RtcDateTime dt= rtc.GetDateTime();
	sprintf(str, "%d/%d/%d",     //%d allows to print an integer to the string
		 dt.Year(),   //get year method
		 dt.Month(),  //get month method
		 dt.Day()  //get second method
		 );

	//Serial.println(str);

	return String(str);
}

String getTimeStr(){
	char str[9];

	RtcDateTime dt= rtc.GetDateTime();
	sprintf(str, "%02d:%02d:%02d",     //%d allows to print an integer to the string
		 dt.Hour(),   //get hour method
		 dt.Minute(), //get minute method
		 dt.Second()  //get second method
		 );

	//Serial.println(str);

	return String(str);
}



void handleRoot() {

	Serial.println("Handle root");
	redLed.changeState();

	refreshSensors();
	refreshDisplay();

	String html="<html>"+getHeader(30);

			html+="<body>\
					<p>\
			<img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAPrSURBVGhD7ZfbSxRxFMd9KQj6G3oJeulBzUu1mqaWZpFlGvVYmd2fkpKIKAWjssIyC42EwAI1y92Ibg8R1UPQhVJTa221hNS1C7a7aunvdM6P2cvo2cWxmW2lOfCB8Tffc8737Mz8ZowywwwzzDDDG/CiepZwWIsIOlaWZ1aIbluGcNjaoNsGBB3TmnI68gO6bPPwCjR6B5iIPIcaRR55Aa0Ns/FXP4xGXdwAgZCGtJSjpEdGCMft1WjsA2c6FJRDuUqZfxei5+Z8NGPlTGqBalAtpWz4Qnyqn4PNSxEPZ2w6UC1ZE2srbYwNvBVyRbe1mzOjB1Sbeijt9A/RdWcBNrnHNTcC6kU9lfZ/H9DfMBccthP4DhjlGhqJ7Im9yYNiZ3ohHM2bcavs5ZqEE/JAXhRbUw/RY12Il/YRV3SqiPdN8NNaoYLWOO1UIU/kTbEZOnD6EuQ3V0gLrjvnoSU6WgWtcVotkDfyqNgNHrgFvuUKaGWw8tCkQWiN02qFPCp2g4cugzis8GV7PvQuXQR9yXGSXkucXKNzbI4GDBnEfa8KnGcPwsizWvn32INK8GxZC66MRBbPlhzUXJADeR5chL7SfbLGxLqh0H8QNGPPy/bdOr2ZqeBasZgdQAVqPqcn+fLs+Ws0XSndB/lRV+Y3kxALP4OY5oYjrT0+xpdPtbgeHLoOIrqaoXNVmjTRSkaWJ6iMegpzYezuOQDUEXTsKVin0vxIS5C5VKNzZaqsyfWaiL5X5CM+0CV7pYmuxEUqg8O78aG235ycg2vDu/JUWsptjY0BZ0XxZH0Q9B1E4XttCfSlxKvMjT+5zGqJ8Sc1Km1faiIMNZxitcEwZBDCFbBLuTeks5pA3Llpfv22HFYTCsMGcRes9xvbnMVqAnFvyvTrMZfThMKQQUafX4XBzCSfMdqhxJvrrJYQr6+pdjHnCgsMPw5+K3LoPoj7fhW0p1igZ7H6YR85toPVEyNHC1Vaym1bgs9JYzmr59B1EGG/Be3LLHLXaouJhqF0vzli9PheEB03/Pr2Rhgt26PSUE4b7lhU413y0il/Het+RQbKi6QJomeJ+qpIspPkdju8E7dcPJ54nnK8+VSL68Gh+yDjnU3QkZHiM/MlWb0Nh6K03rz2tGRZi+vBofsgxDd8j9C30sCZAzDy9Ar8ulSMv76FNS/Bc6T5/bIOvlYfAcfWfFmDqx0MQwbhEK/qwJmfCYP4oqTPEIKOnRuz5K7F5WghbIMQ/Sf3+24dL7TGabUS1kGGmk5PGoTWOK1WwjrIWEu9/KcpEFrjtFoJ6yBGYg4Safxvg1hrUPgwsrHWKHbNMMMMM2ZkREX9Af5QlqKrkORVAAAAAElFTkSuQmCC\">\
			    <h3>Датчики v0.2    </h3>";
			html+="<h2>";
			html+=wiFiSettContainer.DeviceId;
			html+="</h2>";
			html+="</p>";

	html+="<p>";
	html+=sensorsToHtml();
	html+="</p>";
	html+=getTimeFrame();
	html+="</body>\
</html>";

/*	snprintf ( temp, 400,

"<html>\
  <head>\
    <meta http-equiv='refresh' content='5'/>\
    <title>ESP8266 Demo</title>\
    <style>\
      body { background-color: #cccccc; font-family: Arial, Helvetica, Sans-Serif; Color: #000088; }\
    </style>\
  </head>\
  <body>\
    <h1>Hello from ESP8266!</h1>\
    <p>Uptime: %02d:%02d:%02d</p>\
    <img src=\"/test.svg\" />\
  </body>\
</html>",

		hr, min % 60, sec % 60
	);
	*/


	server.send ( 200, "text/html", html );
	redLed.changeState();
}

void handleSettings(){

	 if(!server.authenticate(const_cast<char*>(wiFiSettContainer.settingsUser.c_str()),
			 const_cast<char*>(wiFiSettContainer.settingsPass.c_str()))){
		  return server.requestAuthentication();
	 }

	redLed.changeState();

	int argCount=server.args();
			String time="";
			String date="";

			String year="";
			String month="";
			String day="";

			String hour="";
			String minute="";
			String second="";

			if(argCount!=0){

				time=server.arg("time");
				date=server.arg("date");

				if(date.length()!=0 && time.length()!=0){
					//main settings form submitted
					hour=time.substring(0, 2);
					minute=time.substring(3, 5);
					second=time.substring(6, 8);

					year=date.substring(0, 4);
					month=date.substring(5, 7);
					day=date.substring(8, 10);

					RtcDateTime dateTime=RtcDateTime(year.toInt(),month.toInt(),day.toInt(),hour.toInt(),minute.toInt(),second.toInt());
					rtc.SetDateTime(dateTime);
				}

				if(server.arg("doReset").length()!=0){
					wiFiSettContainer.isAccesPoint=true;
					wiFiSettContainer.putFromVariablesToContainer();
					wiFiSettContainer.saveSettingsToFile(true);
					ESP.reset();
				}
				if(server.arg("doRestart").length()!=0){
					wiFiSettContainer.putFromVariablesToContainer();
					wiFiSettContainer.saveSettingsToFile(true);
					ESP.restart();
				}

				int subArgs=0;

				for(int i=0;i<argCount;i++){
					String argName=server.argName(i);
					String argValue=server.arg(i);
					String preffix=argName.substring(0,KEY_PREFFIX.length());
					String keyValue="";

					Serial.print("argName=");
					Serial.print(argName);
					Serial.print("argValue=");
					Serial.println(argValue);

					if(KEY_PREFFIX==preffix){
						keyValue=argName.substring(KEY_PREFFIX.length());
						Serial.print("sensors descriptor found key=");
						Serial.print(keyValue);
						Serial.print("; value=");
						Serial.print(argValue);
						Serial.println(";");

						sensorHelper.putKeyValue(keyValue, argValue);
						subArgs++;
					}

					preffix=argName.substring(0,SETT_PREFFIX.length());
					keyValue="";

					if(SETT_PREFFIX==preffix){
						keyValue=argName.substring(SETT_PREFFIX.length());
						Serial.print("settings descriptor found key=");
						Serial.print(keyValue);
						Serial.print("; value=");
						Serial.print(argValue);
						Serial.println(";");

						wiFiSettContainer.updateKeyValue(keyValue, argValue);
						subArgs++;
					}
				}


				if(subArgs!=0){
					wiFiSettContainer.putFromContainerToVariables();
					//wiFiSettContainer.saveSettingsToFile(true);
					wiFiSettContainer.saveVariablesToFile();
					sensorTrigger=TimeTrigger(-5000,wiFiSettContainer.refreshInterval*1000);

					sensorsKVContainer.saveToFile(true);

					if(wiFiSettContainer.displayAlvaysOn){
						displayOn=true;
						turnOnDisplay();
					}
				}


			}

		String html="<html>"+getHeader(0);
				  
		html+="<body>\
				<p>\
				<img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAPrSURBVGhD7ZfbSxRxFMd9KQj6G3oJeulBzUu1mqaWZpFlGvVYmd2fkpKIKAWjssIyC42EwAI1y92Ibg8R1UPQhVJTa221hNS1C7a7aunvdM6P2cvo2cWxmW2lOfCB8Tffc8737Mz8ZowywwwzzDDDG/CiepZwWIsIOlaWZ1aIbluGcNjaoNsGBB3TmnI68gO6bPPwCjR6B5iIPIcaRR55Aa0Ns/FXP4xGXdwAgZCGtJSjpEdGCMft1WjsA2c6FJRDuUqZfxei5+Z8NGPlTGqBalAtpWz4Qnyqn4PNSxEPZ2w6UC1ZE2srbYwNvBVyRbe1mzOjB1Sbeijt9A/RdWcBNrnHNTcC6kU9lfZ/H9DfMBccthP4DhjlGhqJ7Im9yYNiZ3ohHM2bcavs5ZqEE/JAXhRbUw/RY12Il/YRV3SqiPdN8NNaoYLWOO1UIU/kTbEZOnD6EuQ3V0gLrjvnoSU6WgWtcVotkDfyqNgNHrgFvuUKaGWw8tCkQWiN02qFPCp2g4cugzis8GV7PvQuXQR9yXGSXkucXKNzbI4GDBnEfa8KnGcPwsizWvn32INK8GxZC66MRBbPlhzUXJADeR5chL7SfbLGxLqh0H8QNGPPy/bdOr2ZqeBasZgdQAVqPqcn+fLs+Ws0XSndB/lRV+Y3kxALP4OY5oYjrT0+xpdPtbgeHLoOIrqaoXNVmjTRSkaWJ6iMegpzYezuOQDUEXTsKVin0vxIS5C5VKNzZaqsyfWaiL5X5CM+0CV7pYmuxEUqg8O78aG235ycg2vDu/JUWsptjY0BZ0XxZH0Q9B1E4XttCfSlxKvMjT+5zGqJ8Sc1Km1faiIMNZxitcEwZBDCFbBLuTeks5pA3Llpfv22HFYTCsMGcRes9xvbnMVqAnFvyvTrMZfThMKQQUafX4XBzCSfMdqhxJvrrJYQr6+pdjHnCgsMPw5+K3LoPoj7fhW0p1igZ7H6YR85toPVEyNHC1Vaym1bgs9JYzmr59B1EGG/Be3LLHLXaouJhqF0vzli9PheEB03/Pr2Rhgt26PSUE4b7lhU413y0il/Het+RQbKi6QJomeJ+qpIspPkdju8E7dcPJ54nnK8+VSL68Gh+yDjnU3QkZHiM/MlWb0Nh6K03rz2tGRZi+vBofsgxDd8j9C30sCZAzDy9Ar8ulSMv76FNS/Bc6T5/bIOvlYfAcfWfFmDqx0MQwbhEK/qwJmfCYP4oqTPEIKOnRuz5K7F5WghbIMQ/Sf3+24dL7TGabUS1kGGmk5PGoTWOK1WwjrIWEu9/KcpEFrjtFoJ6yBGYg4Safxvg1hrUPgwsrHWKHbNMMMMM2ZkREX9Af5QlqKrkORVAAAAAElFTkSuQmCC\">\
				    <h3>Настройки </h3>";
		html+="<h4>";
		html+=wiFiSettContainer.DeviceId;
		html+="</h4>";
		html+="</p>";

		html+="<form method=\"POST\" action=\"settings\">\
		          	 <p>";
		html+="<table style=\"width: 800px;\"><tr><td>";
		html+="<table style=\"width: 400px;\">";
		html+="<tr>\
					<td style=\"width: 200px;\"><h6>Время</h6></td>\
					<td style=\"width: 140px;\"><input type=\"time\" name=\"time\" value=\"";
		html+=getTimeStr();
		html+="\"></td>\
		          	</tr>";
		html+="<tr>\
			<td style=\"width: 200px;\"><h6>Дата</h6></td>\
			<td style=\"width: 140px;\"><input type=\"date\" name=\"date\" value=\"";
			html+=getDateStrMinus();
			html+="\"></td>\
			</tr>";

		html+=wiFiSettContainer.getSettingsHtmlTableBody(SETT_PREFFIX);

		html+="</table>";
		html+="</td>";
		html+="<td style=\"width: 50px;\"></td>";
		html+="<td valign=\"top\">";

		html+="<h5>Настройки датчиков</h5>";
		html+="<table style=\"width: 300px;\">";
		html+="<th>Адресс</th><th>Название датчика</th>";
		html+=sensorHelper.getSettingsHtmlTableBody(KEY_PREFFIX);

		    html+="</table>";
		    html+="</td></tr></table>";
		    html+="</p>\
		          		<input type=\"submit\" name=\"Сохранить\" value=\"Сохранить\">\
		          	</form>\
		          </p>";
		html+="<p>";

		html+="<p>";
		/*
		html+="<form method=\"POST\" action=\"settings\">";
		html+="<input type=\"hidden\" name=\"doReset\" value=\"doReset\">";
		html+="<input type=\"submit\" name=\"Скинуть Установки\" value=\"Скинуть Установки\">";
		html+="</form>";
		html+="<form method=\"POST\" action=\"settings\">";
		html+="<input type=\"hidden\" name=\"doRestart\" value=\"doRestart\">";
		html+="<input type=\"submit\" name=\"Перезагрузить\" value=\"Перезагрузить\">";
		html+="</form>";
		*/
		html+="</p>";
		html+=getTimeFrame();
		html+="</body></html>";

	server.send ( 200, "text/html", html );
	redLed.changeState();
}

String getHeader(int refreshTime){
	String html="<head>";
	if(refreshTime!=0){
		html+="<meta http-equiv='refresh' content='";
		html+=String(refreshTime);
		html+="'/>";
	}

	html+="<meta charset=\"utf-8\">\
    <title>balabas-soft sensors ESP8266 </title>\
    <style>\
      body { background-color: #cccccc; font-family: Arial, Helvetica, Sans-Serif; Color: #000088; }\
    </style>\
  </head>";

	return html;
}

String getTimeFrame(){
	String html="<p>";
	html+="Последнее время измерения:  ";
	html+=getDateStr()+" " +getTimeStr();
	html+="</p>";
	html+="<p>";
	html+="MAC адресс:  ";
	html+=WiFi.macAddress();
	html+="</p>";

	return html;
}

void handleJson(){
	Serial.println("Handle Json");
	refreshSensors();

	String result="{\"device\":\"";
	result+=String(wiFiSettContainer.DeviceId);
	result+="\",\"date\":\"";
	result+=getDateStr();
	result+="\",\"time\": \"";
	result+=getTimeStr();
	result+="\",\"count\":";
	result+=String(getSensorscount());
	result+=",\"sensors\": [";

	for(unsigned int i=0;i<sensorBusCount;i++){
		//result+=sensorHelper.sensorToJson(&dallasTemperatures[i],getDateStr(),getTimeStr(),DeviceId);
		int length=dallasTemperatures[i].getDeviceCount();

		for(int j=0;j<length;j++){
			result+="{\"id\":";
			result+=String(j);
			result+=",\"value\":";
			result+=dallasTemperatures[i].getTempCByIndex(j);
			result+="}";
			if(j!=length-1){
				result+=",";
			}
		}

		if(i!=sensorBusCount-1){
			result+=",";
		}
	}

	result+="],";
	result+="\",\"humidity\":\"";
	result+=dht.readHumidity(true);
	result+="\",\"temp\": \"";
	result+=dht.readTemperature(false, true);
	result+="}";

	server.send ( 200, "text/html", result );
}

void handleNotFound() {
	redLed.changeState();
	String message = "File Not Found\n\n";
	message += "URI: ";
	message += server.uri();
	message += "\nMethod: ";
	message += ( server.method() == HTTP_GET ) ? "GET" : "POST";
	message += "\nArguments: ";
	message += server.args();
	message += "\n";

	for ( uint8_t i = 0; i < server.args(); i++ ) {
		message += " " + server.argName ( i ) + ": " + server.arg ( i ) + "\n";
	}

	server.send ( 404, "text/plain", message );
	redLed.changeState();
}

void drawGraph() {
	String out = "";
	char temp[100];
	out += "<svg xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\" width=\"400\" height=\"150\">\n";
 	out += "<rect width=\"400\" height=\"150\" fill=\"rgb(250, 230, 210)\" stroke-width=\"1\" stroke=\"rgb(0, 0, 0)\" />\n";
 	out += "<g stroke=\"black\">\n";
 	int y = rand() % 130;
 	for (int x = 10; x < 390; x+= 10) {
 		int y2 = rand() % 130;
 		sprintf(temp, "<line x1=\"%d\" y1=\"%d\" x2=\"%d\" y2=\"%d\" stroke-width=\"1\" />\n", x, 140 - y, x + 10, 140 - y2);
 		out += temp;
 		y = y2;
 	}
	out += "</g>\n</svg>\n";

	server.send ( 200, "image/svg+xml", out);

}

void scanI2C(){
	 Wire.begin();

	 byte error, address;
	  int nDevices;

	  Serial.println("Scanning I2C...");

	  nDevices = 0;
	  for(address = 1; address < 127; address++ )
	  {

	    Wire.beginTransmission(address);
	    error = Wire.endTransmission();

	    if (error == 0)
	    {
	      Serial.print("I2C device found at address 0x");
	      if (address<16)
	        Serial.print("0");
	      Serial.print(address,HEX);
	      Serial.println("  !");

	      nDevices++;
	    }
	    else if (error==4)
	    {
	      Serial.print("Unknow error at address 0x");
	      if (address<16)
	        Serial.print("0");
	      Serial.println(address,HEX);
	    }
	  }
	  if (nDevices == 0)
	    Serial.println("No I2C devices found\n");
	  else
	    Serial.println("done\n");

	  delay(5000);
}

KeyValueContainer createKeyValueContainer(String fileName){
	KeyValueContainer kvc=KeyValueContainer(fileName);
	return kvc;
}
/*
void saveSensorsToFile(boolean recreate){

	String path="/sensors.txt";

	boolean executeSave=false;
	boolean fileExists=SPIFFS.exists(path);

	Serial.print("file=");
	Serial.print(path);
	Serial.print("; exists=");
	Serial.print(fileExists);
	Serial.print("; recreate=");
	Serial.println(recreate);

	if(!recreate){
		executeSave=!fileExists;
	}else{
		if(fileExists){
			bool result=SPIFFS.remove(path);

			Serial.print("file=");
			Serial.print(path);
			Serial.print("; removed=");
			Serial.println(result);

			executeSave=true;
		}
	}

	if (executeSave) {
	    Serial.println("save to file to be executed");

	    // open the file in write mode
	    File f = SPIFFS.open(path, "w");
	    if (!f) {
	      Serial.println("file creation failed");
	    }
	    // now write two lines in key/value style with  end-of-line characters

	    uint8_t len=sensorHelper.getMapLength();
	    String* keys=sensorHelper.getKeyArray();
	    String* values=sensorHelper.getValueArray();

	    for(uint8_t i=0;i<len;i++){
	    	String str=keys[i]+"="+values[i];

	    	f.println(str);
	    }

	    f.close();
	  } else {
		  Serial.println("Save to file is not requested");
	  }

	 Serial.println("--------------------");

}

void readSensorsFromFile(){
	String sensorsFIleName="/sensors.txt";

		File f = SPIFFS.open(sensorsFIleName, "r");
		Serial.println("File exists. Reading it");

		  if (f) {		    // we could open the file
		    while(f.available()) {
		      //Lets read line by line from the file
		      String line = f.readStringUntil('\n');
		      if(line.length()>3){
		    	  //parseSensorFileLine(line);
		    	  sensorHelper.putKeyValue(KeyValue(true,line));
			  }
		    }

		    f.close();
		  }
}

void parseSensorFileLine(String line){

	int nli=line.indexOf('\n');
	int endIndex=line.length()-1;

	if(nli>0){
		//Serial.println("Next line found");
		line=line.substring(0,nli-1);
	}else{
		line=line.substring(0, endIndex);
		//Serial.println("Next line not found");
	}

	Serial.println(line);
	int ind=line.indexOf('=');

	if(ind!=0){
		String key=line.substring(0,ind);
		String val=line.substring(ind+1);

		Serial.print("key=");
		Serial.print(key);
		Serial.print("; val=");
		Serial.println(val);

		sensorHelper.putKeyValue(key, val);
	}
}
*/
/*
void setupDisplay(){

	Serial.println("OLED test!");

	  display.print("Hello World");
	  delay(3*1000);

	  display.print("Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.");
	  delay(3*1000);

	  display.clear();
	  delay(3*1000);

	  display.print("TOP-LEFT");
	  display.print("4th row", 4);
	  display.print("RIGHT-BOTTOM", 7, 4);
	  delay(3*1000);

	  display.off();
	  display.print("3rd row", 3, 8);
	  delay(3*1000);

	  display.on();
	  delay(3*1000);
}

void printSensorsToOled(){

	char t[16];
	String time=getTimeStr();
	strcpy(t, time.c_str());
	//display.print(t);

	//int count=getSensorscount();
	String addr=WiFi.localIP().toString();
	char a[16];
	strcpy(a, addr.c_str());
	//display.print(a,1);

	int n=2;

	for (int i=0;i<sensorBusCount;i++){
		for(int j=0;j<dallasTemperatures[i].getDeviceCount();j++){
			float val=dallasTemperatures[i].getTempCByIndex(j);

			char iStr[4];
			char fStr[5];

			sprintf(iStr, "%d", n);
			sprintf(fStr, "%.2f", val);

			//display.print(iStr, n);
			//display.print(fStr, n,2);

			n++;
		}
	}

}

*/
/*
void saveDataToEeprom(String str,int startAddr,int endAddr){

	int len=str.length();

	Serial.print("SaveString");
	Serial.println(str);
	Serial.println("----------");
	for (int i = startAddr; i < endAddr; ++i)
	{
	if((i-startAddr)<len){
	  EEPROM.write(i, str[i-startAddr]);
	  Serial.print("Wrote: ");
	  Serial.println(str[i]);
	}else{
		EEPROM.write(i, 0);
	}

	EEPROM.commit();
	}
}

String getDataFromEeprom(int startAddr,int endAddr){
	String result="";
	uint8_t b;

	Serial.println("Read from EEPROM");
	for (int i = startAddr; i < endAddr; ++i)
	{

	  b=EEPROM.read(i);
	  //Serial.print(b);
	  if(b!=0){
		  result += char(b);
	  }
	}
	Serial.print(result);
	Serial.println("-------");

	return result;
}

void saveDataToEeprom(){
	saveDataToEeprom(ssid,0,32);
	saveDataToEeprom(password,32,96);
	saveDataToEeprom(www_username, 96, 128);
	saveDataToEeprom(www_password, 128, 160);
	saveDataToEeprom(DeviceId, 160, 192);
	saveDataToEeprom(dhtName, 192, 224);
	for(int i=0;i<sensorBusCount;i++){
		saveDataToEeprom(sensorPinDescr[i], 224+i*16, 240+i*16);
	}

}
*/
/*
void write_string_EEPROM (int Addr, String Str) {
    byte lng=Str.length();
    EEPROM.begin (512);
    if (lng>20 )  lng=0;
    EEPROM.write(Addr , lng);
    unsigned char* buf = new unsigned char[15];
    Str.getBytes(buf, lng + 1);
    Addr++;
    for(byte i = 0; i < lng; i++) {EEPROM.write(Addr+i, buf[i]); delay(10);}
    EEPROM.end();
}

char *read_string_EEPROM (int Addr) {
    EEPROM.begin(512);
    byte lng = EEPROM.read(Addr);
    char* buf = new char[20];
    Addr++;
    for(byte i = 0; i < lng; i++) buf[i] = char(EEPROM.read(i+Addr));
    buf[lng] = '\x0';
    //EEPROM.end();
    return buf;
}
*/
